name: Status Updates and Reminders

on:
  schedule:
    # Run every day at 9 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  status-updates:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Stale Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const staleIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc',
              per_page: 100
            });

            for (const issue of staleIssues.data) {
              const lastUpdated = new Date(issue.updated_at);
              if (lastUpdated < thirtyDaysAgo && !issue.labels.some(label => label.name === 'stale')) {
                const staleMessage = [
                  `## ‚è∞ Issue Status Update`,
                  ``,
                  `This issue hasn't been updated in over 30 days.`,
                  ``,
                  `### üîÑ What You Can Do`,
                  `- **Still relevant?** Please update this issue`,
                  `- **Need help?** Join our [Discord](https://discord.gg/BtqrauPm)`,
                  `- **Completed?** Close if resolved`,
                  `- **No longer needed?** Close if irrelevant`,
                  ``,
                  `### üìÖ Timeline`,
                  `- **Last Updated**: ${lastUpdated.toLocaleDateString()}`,
                  `- **Days Since Update**: ${Math.floor((new Date() - lastUpdated) / (1000*60*60*24))}`,
                  ``,
                  `---
                  *Automated reminder.*`
                ].join('\n');
                
                await github.rest.issues.createComment({
                  issue_number: issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: staleMessage
                });
                
                await github.rest.issues.addLabels({
                  issue_number: issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  labels: ['stale']
                });
              }
            }

      - name: Check Stale PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const stalePRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc',
              per_page: 100
            });

            for (const pr of stalePRs.data) {
              const lastUpdated = new Date(pr.updated_at);
              if (lastUpdated < sevenDaysAgo && !pr.labels.some(label => label.name === 'stale')) {
                const staleMessage = [
                  `## ‚è∞ PR Status Update`,
                  ``,
                  `This pull request hasn't been updated in over 7 days.`,
                  ``,
                  `### üîÑ What You Can Do`,
                  `- **Ready for review?** Request review`,
                  `- **Need changes?** Update PR`,
                  `- **Need help?** Join [Discord](https://discord.gg/BtqrauPm)`,
                  `- **No longer needed?** Close if irrelevant`,
                  ``,
                  `### üìÖ Timeline`,
                  `- **Last Updated**: ${lastUpdated.toLocaleDateString()}`,
                  `- **Days Since Update**: ${Math.floor((new Date() - lastUpdated) / (1000*60*60*24))}`,
                  ``,
                  `---
                  *Automated reminder.*`
                ].join('\n');

                await github.rest.issues.createComment({
                  issue_number: pr.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: staleMessage
                });
                
                await github.rest.issues.addLabels({
                  issue_number: pr.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  labels: ['stale']
                });
              }
            }

      - name: Weekly Summary
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - 7);

            const summaryTitle = `üìä Weekly Project Summary - ${today.toLocaleDateString()}`;

            const recentIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: weekStart.toISOString(),
              per_page: 50
            });

            const recentPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 50
            });

            const newIssues = recentIssues.data.filter(i => new Date(i.created_at) >= weekStart && !i.pull_request);
            const newPRs = recentPRs.data.filter(pr => new Date(pr.created_at) >= weekStart);
            const mergedPRs = recentPRs.data.filter(pr => pr.merged_at && new Date(pr.merged_at) >= weekStart);

            const summaryBody = [
              `## üìä Weekly Project Summary`,
              ``,
              `**Period**: ${weekStart.toLocaleDateString()} - ${today.toLocaleDateString()}`,
              ``,
              `### üìà Activity Overview`,
              `- üÜï **New Issues**: ${newIssues.length}`,
              `- üöÄ **New PRs**: ${newPRs.length}`,
              `- ‚úÖ **Merged PRs**: ${mergedPRs.length}`,
              `- üë• **Active Contributors**: ${new Set([...newIssues.map(i => i.user.login), ...newPRs.map(p => p.user.login)]).size}`,
              ``,
              `### üÜï New Issues This Week`,
              newIssues.length > 0 ? newIssues.map(issue => `- [#${issue.number}](${issue.html_url}) ${issue.title} by @${issue.user.login}`).join('\n') : 'No new issues this week',
              ``,
              `### üöÄ New PRs This Week`,
              newPRs.length > 0 ? newPRs.map(pr => `- [#${pr.number}](${pr.html_url}) ${pr.title} by @${pr.user.login}`).join('\n') : 'No new PRs this week',
              ``,
              `### ‚úÖ Merged PRs This Week`,
              mergedPRs.length > 0 ? mergedPRs.map(pr => `- [#${pr.number}](${pr.html_url}) ${pr.title} by @${pr.user.login}`).join('\n') : 'No merged PRs this week',
              ``,
              `### üéØ Next Week's Goals`,
              `- [ ] Review and merge pending PRs`,
              `- [ ] Address stale issues and PRs`,
              `- [ ] Welcome new contributors`,
              `- [ ] Update project documentation`,
              ``,
              `---
              *Automated weekly summary.*`
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: summaryTitle,
              body: summaryBody,
              labels: ['weekly-summary', 'automated']
            });
