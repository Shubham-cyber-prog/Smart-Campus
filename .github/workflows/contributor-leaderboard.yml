name: ğŸ† Contributor Leaderboard

on:
  schedule:
    - cron: "0 10 * * 0"   # Every Sunday
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: read
  contents: read

jobs:
  leaderboard:
    runs-on: ubuntu-latest

    steps:
      - name: Generate Weekly Contributor Leaderboard
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const DAYS = 7;

            console.log(`ğŸ“Š Generating leaderboard for last ${DAYS} days`);

            const since = new Date();
            since.setDate(since.getDate() - DAYS);

            const stats = {};

            const isValidUser = (user) =>
              user &&
              !user.endsWith('[bot]') &&
              user !== owner;

            const add = (user, type) => {
              if (!isValidUser(user)) return;
              if (!stats[user]) {
                stats[user] = { prs: 0, merged: 0, issues: 0 };
              }
              stats[user][type]++;
            };

            // Fetch PRs
            const prs = await github.paginate(
              github.rest.pulls.list,
              { owner, repo, state: "all", per_page: 100 }
            );

            prs.forEach(pr => {
              if (new Date(pr.created_at) >= since) {
                add(pr.user.login, "prs");
                if (pr.merged_at) add(pr.user.login, "merged");
              }
            });

            // Fetch Issues
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: "all", per_page: 100 }
            );

            issues.forEach(issue => {
              if (!issue.pull_request && new Date(issue.created_at) >= since) {
                add(issue.user.login, "issues");
              }
            });

            const leaderboard = Object.entries(stats)
              .map(([user, data]) => ({
                user,
                ...data,
                total: data.prs + data.issues + data.merged
              }))
              .sort((a, b) => b.total - a.total)
              .slice(0, 10);

            if (leaderboard.length === 0) {
              console.log("âš ï¸ No contributors found this week.");
              return;
            }

            const medals = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"];

            const rows = leaderboard.map((c, i) => {
              const rank = medals[i] || `#${i + 1}`;
              return `| ${rank} | @${c.user} | ${c.prs} | ${c.merged} | ${c.issues} | ${c.total} |`;
            });

            const body = `
            ## ğŸ† Weekly Contributor Leaderboard
            â± **Last ${DAYS} Days**

            | Rank | Contributor | PRs | Merged | Issues | Total |
            |------|-------------|-----|--------|--------|-------|
            ${rows.join("\n")}

            ğŸ‰ **Amazing work everyone!**
            Your contributions keep this project alive ğŸš€

            ---
            ğŸ¤– _Auto-generated every week_
            `;

            // Check existing leaderboard issue
            const existing = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: "leaderboard",
              state: "open"
            });

            if (existing.data.length > 0) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: existing.data[0].number,
                body
              });
              console.log("â™»ï¸ Updated existing leaderboard issue");
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title: "ğŸ† Weekly Contributor Leaderboard",
                body,
                labels: ["leaderboard", "automated"]
              });
              console.log("âœ… Created new leaderboard issue");
            }
